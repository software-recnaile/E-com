# =====================================================================
# GLOBAL SSL CONFIG (must NOT be inside VirtualHost)
# =====================================================================

LoadModule ssl_module modules/mod_ssl.so
LoadModule socache_shmcb_module modules/mod_socache_shmcb.so

SSLSessionCache shmcb:/usr/local/apache2/logs/ssl_scache(512000)
SSLSessionCacheTimeout 300

# =====================================================================
# REDIRECT HTTP â†’ HTTPS
# =====================================================================
<VirtualHost *:80>
    ServerName api.recnaile.com
    Redirect permanent / https://api.recnaile.com/
</VirtualHost>

# =====================================================================
# HTTPS REVERSE PROXY
# =====================================================================
<VirtualHost _default_:443>
    ServerAdmin webmaster@api.recnaile.com
    ServerName api.recnaile.com

    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/api.recnaile.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/api.recnaile.com/privkey.pem
    SSLCertificateChainFile /etc/letsencrypt/live/api.recnaile.com/chain.pem

    SSLProtocol all -SSLv2 -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite HIGH:!aNULL:!MD5:!3DES
    SSLHonorCipherOrder on

    ProxyPreserveHost On
    ProxyRequests Off

    # ================== AuthService =====================
    ProxyPass /api/auth http://authservice:8081/api/auth
    ProxyPassReverse /api/auth http://authservice:8081/api/auth

    ProxyPass /api/logs http://authservice:8081/api/logs
    ProxyPassReverse /api/logs http://authservice:8081/api/logs

    # ================== AccountService =====================
    ProxyPass /api/orders http://accountservice:8082/api/orders
    ProxyPassReverse /api/orders http://accountservice:8082/api/orders

    ProxyPass /api/activity-logs http://accountservice:8082/api/activity-logs
    ProxyPassReverse /api/activity-logs http://accountservice:8082/api/activity-logs

    # ================== ProductService =====================
    ProxyPass /api/products http://productservice:8083/api/products
    ProxyPassReverse /api/products http://productservice:8083/api/products

    # ================== CartService =====================
    ProxyPass /api/cart http://cartservice:8084/api/cart
    ProxyPassReverse /api/cart http://cartservice:8084/api/cart

    # ================== WishlistService =====================
    ProxyPass /api/wishlists http://wishlistservice:8085/api/wishlists
    ProxyPassReverse /api/wishlists http://wishlistservice:8085/api/wishlists

    # ================== ProfileService =====================
    ProxyPass /api/user-profiles http://profile:8086/api/user-profiles
    ProxyPassReverse /api/user-profiles http://profile:8086/api/user-profiles

    # ================== BulkOrderService =====================
    ProxyPass /api/bulk-orders http://bulkorderservice:8087/api/bulk-orders
    ProxyPassReverse /api/bulk-orders http://bulkorderservice:8087/api/bulk-orders

    ProxyPass /api/bulkorder-activity-logs http://bulkorderservice:8087/api/activity-logs
    ProxyPassReverse /api/bulkorder-activity-logs http://bulkorderservice:8087/api/activity-logs

    # ================== AddressService =====================
    ProxyPass /api/addresses http://address:8088/api/addresses
    ProxyPassReverse /api/addresses http://address:8088/api/addresses

    # ================== MailService =====================
    ProxyPass /api/drone-plans http://mailservice:8089/api/drone-plans
    ProxyPassReverse /api/drone-plans http://mailservice:8089/api/drone-plans

    ProxyPass /api/mail-activity-logs http://mailservice:8089/api/activity-logs
    ProxyPassReverse /api/mail-activity-logs http://mailservice:8089/api/activity-logs

    ErrorLog "/usr/local/apache2/logs/error_ssl.log"
    CustomLog "/usr/local/apache2/logs/access_ssl.log" combined
</VirtualHost>
