services:
  apache:
    build: ./apache
    container_name: apache
    ports:
      - "8080:80"     # HTTP → Redirects to HTTPS
      - "443:443"   # HTTPS main site
    volumes:
      # Mount your Apache config
      - ./apache/conf:/usr/local/apache2/conf/extra:ro

      # Mount Let's Encrypt certs from host → container (required for SSL)
      - /etc/letsencrypt:/etc/letsencrypt:ro

    depends_on:
      - authservice
      - accountservice
      - productservice
      - cartservice
      - wishlistservice
      - profile
      - bulk-order-service
      - address
      - mailservice

    environment:
      - Tech2025=${Tech2025}

    networks:
      - recnaile-net

  authservice:
    build: ./authService
    container_name: authservice
    expose:
      - "8081"
    environment:
      - Tech2025=${Tech2025}
    networks:
      - recnaile-net

  accountservice:
    build: ./accountService
    container_name: accountservice
    expose:
      - "8082"
    environment:
      - Tech2025=${Tech2025}
    networks:
      - recnaile-net

  productservice:
    build: ./productService
    container_name: productservice
    expose:
      - "8083"
    environment:
      - Tech2025=${Tech2025}
    networks:
      - recnaile-net

  cartservice:
    build: ./cartService
    container_name: cartservice
    expose:
      - "8084"
    environment:
      - Tech2025=${Tech2025}
    networks:
      - recnaile-net

  wishlistservice:
    build: ./wishlistService
    container_name: wishlistservice
    expose:
      - "8085"
    environment:
      - Tech2025=${Tech2025}
    networks:
      - recnaile-net

  profile:
    build: ./profile
    container_name: profile
    expose:
      - "8086"
    environment:
      - Tech2025=${Tech2025}
    networks:
      - recnaile-net

  bulk-order-service:
    build: ./bulkorderservice
    container_name: bulkorderservice
    ports:
      - "8087:8087"
    environment:
      - GOOGLE_SHEETS_SPREADSHEET_ID=152ptNLn-Ir4pjSE9taj7Ddw8yGcTEnILryvvAXcW4HA
      - GOOGLE_SHEETS_SHEET_NAME=BulkOrders
      - SPRING_DATA_ADMIN_MONGODB_URI=mongodb+srv://software:%24Tech2025@recnaile.ffukcey.mongodb.net/admin-db?retryWrites=true&w=majority&appName=Recnaile
      - SPRING_DATA_ACCOUNT_MONGODB_URI=mongodb+srv://software:%24Tech2025@recnaile.ffukcey.mongodb.net/account-db?retryWrites=true&w=majority&appName=Recnaile
      - Tech2025=${Tech2025}
    volumes:
      - ./docker/credentials.json:/app/config/credentials.json:ro  # Use shared docker credentials
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8087/actuator/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - recnaile-net

  address:
    build: ./address
    container_name: address
    expose:
      - "8088"
    environment:
      - Tech2025=${Tech2025}
    networks:
      - recnaile-net

  mailservice:
    build: ./mailService
    container_name: mailservice
    ports:
      - "8890:8089"
    environment:
      - Tech2025=${Tech2025}
      - GOOGLE_SHEETS_SPREADSHEET_ID=16lsEGCi6AqKWiqpBdz2FZwHk99eBAZnwS_Lv3P1NTgw
      - GOOGLE_SHEETS_SHEET_NAME=Customization
    volumes:
      - ./docker/credentials.json:/app/config/credentials.json:ro  # Use shared docker credentials
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8089/actuator/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - recnaile-net

networks:
  recnaile-net:
    driver: bridge
